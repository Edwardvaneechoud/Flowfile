services:
  flowfile-frontend:
    platform: linux/amd64
    build:
      context: .
      dockerfile: flowfile_frontend/Dockerfile
    ports:
      - "8080:8080"
    networks:
      - flowfile-network
    environment:
      - NODE_ENV=production
    depends_on:
      - flowfile-core
      - flowfile-worker

  flowfile-core:
    platform: linux/amd64
    build:
      context: .
      dockerfile: flowfile_core/Dockerfile
    ports:
      - "63578:63578"
    shm_size: '2gb'
    environment:
      - FLOWFILE_MODE=docker
      - FLOWFILE_ADMIN_USER=${FLOWFILE_ADMIN_USER:-admin}
      - FLOWFILE_ADMIN_PASSWORD=${FLOWFILE_ADMIN_PASSWORD:-changeme}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-flowfile-dev-secret-change-in-production}
      - WORKER_HOST=flowfile-worker
      - FLOWFILE_STORAGE_DIR=/app/internal_storage
      - FLOWFILE_USER_DATA_DIR=/app/user_data
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    volumes:
      - ./flowfile_data:/app/user_data
      - flowfile-internal-storage:/app/internal_storage
      - ./saved_flows:/app/flowfile_core/saved_flows
    networks:
      - flowfile-network
    secrets:
      - flowfile_master_key

  flowfile-worker:
    platform: linux/amd64
    build:
      context: .
      dockerfile: flowfile_worker/Dockerfile
    ports:
      - "63579:63579"
    shm_size: '2gb'
    environment:
      - FLOWFILE_MODE=docker
      - CORE_HOST=flowfile-core
      - FLOWFILE_STORAGE_DIR=/app/internal_storage
      - FLOWFILE_USER_DATA_DIR=/app/user_data
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    volumes:
      - ./flowfile_data:/app/user_data
      - flowfile-internal-storage:/app/internal_storage
    networks:
      - flowfile-network
    secrets:
      - flowfile_master_key

networks:
  flowfile-network:
    driver: bridge

volumes:
  flowfile-internal-storage:
    driver: local

secrets:
  flowfile_master_key:
    file: ./master_key.txt
