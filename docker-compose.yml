version: '3.8'

services:
  flowfile-frontend:
    platform: linux/amd64
    build:
      context: .
      dockerfile: flowfile_frontend/Dockerfile
    ports:
      - "8080:8080"
    networks:
      - flowfile-network
    environment:
      - NODE_ENV=production
    depends_on:
      - flowfile-core
      - flowfile-worker

  flowfile-core:
    platform: linux/amd64
    build:
      context: .
      dockerfile: flowfile_core/Dockerfile
    ports:
      - "63578:63578"
    environment:
      # FLOWFILE_MODE: "electron" (desktop), "package" (Python package), "docker" (container)
      - FLOWFILE_MODE=docker
      - FLOWFILE_ADMIN_USER=${FLOWFILE_ADMIN_USER:-admin}
      - FLOWFILE_ADMIN_PASSWORD=${FLOWFILE_ADMIN_PASSWORD:-changeme}
      # JWT secret key for token signing - CHANGE THIS IN PRODUCTION
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-flowfile-dev-secret-change-in-production}
      - WORKER_HOST=flowfile-worker
      # Internal storage for container communication (logs, cache, temp)
      - FLOWFILE_STORAGE_DIR=/app/internal_storage
      # User data directory for file explorer and user files
      - FLOWFILE_USER_DATA_DIR=/app/user_data
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    volumes:
      - flowfile-user-data:/app/user_data
      - flowfile-internal-storage:/app/internal_storage
      - ./saved_flows:/app/flowfile_core/saved_flows
    networks:
      - flowfile-network
    secrets:
      - flowfile_master_key

  flowfile-worker:
    build:
      context: .
      dockerfile: flowfile_worker/Dockerfile
    ports:
      - "63579:63579"
    environment:
      - FLOWFILE_MODE=docker
      - CORE_HOST=flowfile-core
      # Same internal storage as core for communication
      - FLOWFILE_STORAGE_DIR=/app/internal_storage
      # Access to user data for processing
      - FLOWFILE_USER_DATA_DIR=/app/user_data
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    volumes:
      # User data volume - for accessing user files
      - flowfile-user-data:/app/user_data
      # Internal storage volume - shared with core
      - flowfile-internal-storage:/app/internal_storage
    networks:
      - flowfile-network
    secrets:
      - flowfile_master_key

networks:
  flowfile-network:
    driver: bridge

volumes:
  # Internal container communication (logs, cache, temp files)
  # This volume is ephemeral and can be recreated
  flowfile-internal-storage:
    driver: local

  # User-accessible data (flows, uploads, outputs)
  # This volume should be persistent and backed up
  flowfile-user-data:
    driver: local

secrets:
  flowfile_master_key:
    file: ./master_key.txt