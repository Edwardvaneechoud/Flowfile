services:
  flowfile-frontend:
    build:
      context: .
      dockerfile: flowfile_frontend/Dockerfile
    ports:
      - "8080:8080"
    networks:
      - flowfile-network
    environment:
      - NODE_ENV=production
    depends_on:
      - flowfile-core
      - flowfile-worker

  flowfile-core:
    build:
      context: .
      dockerfile: flowfile_core/Dockerfile
    ports:
      - "63578:63578"
      - "50052:50052"  # gRPC logging port
    shm_size: '2gb'
    environment:
      - FLOWFILE_MODE=docker
      - FLOWFILE_ADMIN_USER=${FLOWFILE_ADMIN_USER:-admin}
      - FLOWFILE_ADMIN_PASSWORD=${FLOWFILE_ADMIN_PASSWORD:-changeme}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-flowfile-dev-secret-change-in-production}
      # Master key for encrypting secrets - if not set, setup screen will prompt to configure
      - FLOWFILE_MASTER_KEY=${FLOWFILE_MASTER_KEY:-}
      - WORKER_HOST=flowfile-worker
      - WORKER_GRPC_HOST=flowfile-worker
      - FLOWFILE_WORKER_GRPC_PORT=50051
      - FLOWFILE_USE_GRPC=1
      - FLOWFILE_STORAGE_DIR=/app/internal_storage
      - FLOWFILE_USER_DATA_DIR=/app/user_data
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    volumes:
      - ./flowfile_data:/app/user_data
      - flowfile-internal-storage:/app/internal_storage
      - ./saved_flows:/app/flowfile_core/saved_flows
    networks:
      - flowfile-network

  flowfile-worker:
    build:
      context: .
      dockerfile: flowfile_worker/Dockerfile
    ports:
      - "63579:63579"
      - "50051:50051"  # gRPC worker port
    shm_size: '2gb'
    environment:
      - FLOWFILE_MODE=docker
      - CORE_HOST=flowfile-core
      - FLOWFILE_WORKER_GRPC_PORT=50051
      - FLOWFILE_LOGGING_GRPC_PORT=50052
      - FLOWFILE_USE_GRPC=1
      # Master key for encrypting secrets - must match flowfile-core
      - FLOWFILE_MASTER_KEY=${FLOWFILE_MASTER_KEY:-}
      - FLOWFILE_STORAGE_DIR=/app/internal_storage
      - FLOWFILE_USER_DATA_DIR=/app/user_data
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    volumes:
      - ./flowfile_data:/app/user_data
      - flowfile-internal-storage:/app/internal_storage
    networks:
      - flowfile-network

networks:
  flowfile-network:
    driver: bridge

volumes:
  flowfile-internal-storage:
    driver: local
